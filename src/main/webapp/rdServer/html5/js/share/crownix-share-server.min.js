exports.start=function(){process.on("uncaughtException",function(n){if(m){m.log("crit","[uncaughtException] "+n.stack)}else{console.log("[uncaughtException] "+n.stack)}});var h=require("fs");var c=JSON.parse(h.readFileSync("./config.json","utf-8"));var b=h.readdirSync("./").indexOf("crownix-share-logger.js")>=0?require("./crownix-share-logger.js"):require("./crownix-share-logger.min.js");var g=require("v8");var d=require("os");var m=new b(c.server.log);var i=require("socket.io").listen(c.server.port||52280,{pingInterval:c.server.opts.pingInterval||60000,pingTimeout:c.server.opts.pingTimeout||210000});console.log("Server Running at http://ServerURL:"+c.server.port);m.log("info","[Server start] module load complete. Share Server start. \r\n Node.js Version:"+process.version+" \r\n OS type: "+d.type());var j=function(t,y){var o=t.name,A=t.password,w=t.mrd,x=t.curPage,r=(t.formData&&t.formData.formData)||{},n=(t.formData&&t.formData.removedPage)||{},v=(t.formData&&t.formData.drilldownInfo)||{},C={},q=[],y=y,z=true,u=0;syncState="wait";this.reopenReport=function(D){w=D.mrd,x=D.curPage,r=(D.formData&&D.formData.formData)||{},n=(D.formData&&D.formData.removedPage)||{},v=(D.formData&&D.formData.drilldownInfo)||{},C={},q=[],u=0,syncState="wait"};this.focusOnField=function(G,I){for(var E=0;E<r.formdata.form.length;E++){var F=r.formdata.form[E];if(F.id==G.formId){for(var D=0;D<F.fields.field.length;D++){var H=F.fields.field[D];if(H.id==G.fieldId){H.owner=I;break}}break}}};this.focusOutField=function(H){for(var E=0;E<r.formdata.form.length;E++){var F=r.formdata.form[E];for(var D=0;D<F.fields.field.length;D++){var G=F.fields.field[D];if(G.owner==H){G.owner=undefined;return{formId:F.id,fieldId:G.id}}}}};this.getFormData=function(){return r};this.getNoteData=function(){return C};var B=function(E){if(typeof E!=="string"||E.length==0){return}var D=E.substr(E.indexOf('path="')+6);return D.substr(0,D.indexOf('"'))};this.drawNote=function(G){var F=G.curPage;if(!C[F]||G.type=="clearElement"){C[F]=[]}if(G.type=="scribble"){C[F].push(G)}else{if(G.type=="erase"){for(var E=0;E<C[F].length;E++){var D=C[F][E].xml,H=G.xml;if(B(D)==B(H)){C[F].splice(E,1);break}}}}if(a.getHeapProportion()>95){m.log("warning","heap memory proportion: "+a.getHeapProportion()+"%. becoming closer to the heap size limit.")}return C[F]};this.changeField=function(G){try{for(var E=0;E<r.formdata.form.length;E++){var F=r.formdata.form[E];if(F.id==G.formId){for(var D=0;D<F.fields.field.length;D++){var I=F.fields.field[D];if(I.id==G.fieldId){if(G.name=="editable"||G.name=="required"){I[G.name]=G.value?"1":"0"}else{if(G.name=="label"){I.label={__cdata:G.value}}else{if(I.type==="co"){I.selectedIndex=G.value}else{if(I.type==="rg"){I.selectedId=G.value}else{if(I.type==="rb"&&G.name=="selected"){this.changeField({formId:G.formId,fieldId:G.groupId,value:G.fieldId})}else{I.value={__cdata:G.value}}}}}}break}}break}}}catch(H){m.log("error","[changeField error] "+H)}};var p=function(F){for(var D=0;D<r.formdata.form.length;D++){var E=r.formdata.form[D];if(E.id==F){return E}}};var s=function(I,D){for(var F=0;F<r.formdata.form.length;F++){var G=r.formdata.form[F];if(G.id==I){for(var E=0;E<G.fields.field.length;E++){var H=G.fields.field[E];if(H.id==D){return H}}}}};this.setFormData=function(H){if(!H){return}for(var F=0;F<H.formdata.form.length;F++){var G=H.formdata.form[F],D=p(G.id);if(!D){D={id:G.id,fields:{field:[]}};r.formdata.form.push(D)}for(var E=0;E<G.fields.field.length;E++){var I=G.fields.field[E];if(!s(D.id,I.id)){D.fields.field.push(I)}}}};this.setDrilldownInfo=function(D){if(!D){return}v=D};this.changeLock=function(D){z=D};this.changeLock=function(D){z=D};this.isLock=function(){return z};this.getName=function(){return o};this.getPassword=function(){return A};this.getMrd=function(){return w};this.getCurPage=function(){return x};this.setHostId=function(D){y=D};this.getHostId=function(){return y};this.getFormData=function(){return r};this.getRemovedPage=function(){return n};this.getDrilldownInfo=function(){return v};this.syncDone=function(){++u};this.initSyncDoneCount=function(){u=0};this.getSyncDoneCount=function(){return u};this.setSyncState=function(D){syncState=D};this.getSyncState=function(){return syncState};this.setHostPage=function(D){x=D}};var f=function(){var n=[];this.createReport=function(p,q){if(!this.getReport(p.name)){var o=new j(p,q);n.push(o);i.to("waiting").emit("newReport",{name:p.name,isPublic:!p.password});if(a.getHeapProportion()>95){m.log("warning","heap memory proportion: "+a.getHeapProportion()+"%. becoming closer to the heap size limit.")}return o}};this.joinReport=function(p,q){var o=this.getReport(q.name);if(o){if(o.getPassword()&&o.getPassword()!=q.password){return"share_wrong_password"}p.emit("openFile",{mrd:o.getMrd(),pageNo:o.getCurPage(),formData:{formData:o.getFormData(),removedPage:o.getRemovedPage(),drilldownInfo:o.getDrilldownInfo()},noteData:o.getNoteData(),isLock:o.isLock()});if(!q.reconnect){i.to("waiting").emit("renewUserCount",{name:q.name,incCount:true})}return o}else{return"share_undefined_room"}};this.getReport=function(p){var o;n.some(function(q){if(p==q.getName()){o=q;return true}});return o};this.getReports=function(){return n};this.getReportList=function(){var o=n.sort(function(r,q){if(r.getName()<q.getName()){return -1}if(r.getName()>q.getName()){return 1}return 0});var p=[];o.forEach(function(q){p.push({name:q.getName(),isPublic:!q.getPassword(),userCount:k(q.getName())})});return p};this.removeReport=function(o){n.some(function(p){if(p.getName()===o){n.splice(n.indexOf(p),1);return true}})};this.destroyReport=function(o){i.to(o).emit("hostDoesNotExist","share_stop_sharing");this.removeReport(o)}};var l=function(){this.getHeapUsage=function(){var n=g.getHeapStatistics();return((n.used_heap_size/n.total_heap_size)*100).toFixed(2)};this.getHeapProportion=function(){var n=g.getHeapStatistics();return((n.total_heap_size/n.heap_size_limit)*100).toFixed(2)}};var k=function(n){var o=i.sockets.adapter.rooms[n];return o?o.length:0};var e=new f();var a=new l();i.sockets.on("connection",function(p){m.log("debug","[client connect] new client "+p.id+" connect.");var o,q="waiting";function n(s){p.leave(q);p.join(s);q=s}function r(){p.leave(q);p.join("waiting");q="waiting"}p.join(q);p.emit("reportList",e.getReportList());p.on("createReport",function(u,s){var t=e.createReport(u,p.id);if(t){o=t;n(u.name);p.emit("startSharing","host");s({name:u.name,password:u.password});m.log("info","[create report] report created. \r\n name: "+u.name+" \r\n host: "+p.id+" \r\n type: "+(u.password?"private":"public"))}else{p.emit("shareError",{message:"share_duplicated_name"})}});p.on("reopenReport",function(s){o.reopenReport(s);p.broadcast.to(q).emit("openFile",{mrd:o.getMrd(),pageNo:o.getCurPage(),formData:{formData:o.getFormData(),removedPage:o.getRemovedPage(),drilldownInfo:o.getDrilldownInfo()},noteData:o.getNoteData(),isLock:o.isLock()});m.log("info","[reopen report] report reopened. \r\n report: "+o.getName()+" \r\n opener: "+p.id)});p.on("joinReport",function(v,s){var t=e.joinReport(p,v);if(t&&typeof t==="object"){o=t;n(v.name);var u=v.isHost;if(u){o.setHostId(p.id)}p.emit("startSharing",u?"host":"client");s({name:v.name,password:v.password});m.log("info","[join report] client "+p.id+" join report: "+v.name)}else{if(t&&typeof t==="string"){p.emit("shareError",{message:t})}}});p.on("formField",function(s){if(o){o.changeField(s);p.broadcast.to(q).emit("formField",s)}});p.on("drilldownInfo",function(s){if(o){o.setDrilldownInfo(s.drilldownInfo);o.setFormData(s.formData)}});p.on("focusOn",function(t){if(o){var s=o.focusOutField(p.id);if(s){p.broadcast.to(q).emit("focusOut",s)}o.focusOnField(t,p.id);t.isLock=o.isLock();p.broadcast.to(q).emit("focusOn",t)}});p.on("focusOut",function(){if(o){var s=o.focusOutField(p.id);if(s){p.broadcast.to(q).emit("focusOut",s)}}});p.on("lockFields",function(){if(!o.isLock()){o.changeLock(true);p.broadcast.to(q).to(q).emit("lockFields");p.broadcast.to(q).emit("movePage",o.getCurPage())}});p.on("unlockFields",function(){if(o.isLock()){o.changeLock(false);p.broadcast.to(q).emit("unlockFields")}});p.on("submitRequest",function(w,t){m.log("info","[submit request] client "+p.id+" request for submit. \r\n report: "+o.getName());var v=o.getSyncState();if(v==="synchronization"||v==="done"){return}o.setSyncState("synchronization");var s=Object.keys(i.sockets.adapter.rooms[q].sockets);if(s.length===1){t("done");o.setSyncState("done");return}for(var u=0;u<s.length;u++){(function(){var x=u;i.sockets.connected[s[x]].once("syncDone",function(){o.syncDone();m.log("debug","[sync done] sync done event emitted from client "+i.sockets.connected[s[x]].id);if(o.getSyncDoneCount()===(k(q)-1)){t("done");o.setSyncState("done");m.log("debug","[all client sync done] all client sync done event emitted in report "+q)}})})()}p.broadcast.to(q).emit("syncFormData",{formData:o.getFormData(),removedPage:o.getRemovedPage(),drilldownInfo:o.getDrilldownInfo()});m.log("debug","[sync form data] form data broadcast for field synchronization. in report "+q)});p.on("submitFinished",function(s){m.log("info","[submit finished] submit finished. \r\n report: "+o.getName());p.broadcast.to(q).emit("submitFinished",s)});p.on("submitFailed",function(){m.log("info","[submit failed] submit failed in report: "+o.getName()+" maybe some error has occurred.");o.setSyncState("wait");o.initSyncDoneCount();p.broadcast.to(q).emit("submitFailed")});p.on("note",function(s){if(o){var t=o.drawNote(s);p.broadcast.to(q).emit("note",s)}});p.on("script",function(s){if(o){if(s.name!=="expandDrilldown"&&s.name!=="collapseDrilldown"){o.changeField(s)}p.broadcast.to(q).emit("script",s)}});p.on("movePage",function(s){if(o){if(s.isHost){if(o.isLock()){p.broadcast.to(q).emit("movePage",s.page)}o.setHostPage(s.page)}}});p.on("isLock",function(s){if(!o.isLock()){s()}});p.on("error",function(s){throw new Error(s)});p.on("disconnect",function(t){m.log("debug","[client disconnect] client "+p.id+" disconnect. \r\n reason: "+t+" \r\n latest join: "+q);if(o&&k(q)===0){i.to("waiting").emit("removeReport",q);e.removeReport(q);m.log("info",'[destroy report] report "'+o.getName()+'" destroyed.')}else{if(o&&p.id===o.getHostId()){e.destroyReport(q);return}if(o){var s=o.focusOutField(p.id);if(s){p.broadcast.to(q).emit("focusOut",s)}}i.to("waiting").emit("renewUserCount",{name:q,incCount:false})}})})};