if(typeof Effect=="undefined")throw"dragdrop.js requires including script.aculo.us' effects.js library"; var Droppables={drops:[],remove:function(a){this.drops=this.drops.reject(function(b){return b.element==$(a)})},add:function(a,b){a=$(a);var c=Object.extend({greedy:true,hoverclass:null,tree:false},b||{});if(c.containment){c._containers=[];b=c.containment;typeof b=="object"&&b.constructor==Array?b.each(function(d){c._containers.push($(d))}):c._containers.push($(b))}if(c.accept)c.accept=[c.accept].flatten();Element.makePositioned(a);c.element=a;this.drops.push(c)},findDeepestChild:function(a){deepest= a[0];for(i=1;i<a.length;++i)if(Element.isParent(a[i].element,deepest.element))deepest=a[i];return deepest},isContained:function(a,b){var c;c=b.tree?a.treeNode:a.parentNode;return b._containers.detect(function(d){return c==d})},isAffected:function(a,b,c){return c.element!=b&&(!c._containers||this.isContained(b,c))&&(!c.accept||Element.classNames(b).detect(function(d){return c.accept.include(d)}))&&Position.within(c.element,a[0],a[1])},deactivate:function(a){a.hoverclass&&Element.removeClassName(a.element, a.hoverclass);this.last_active=null},activate:function(a){a.hoverclass&&Element.addClassName(a.element,a.hoverclass);this.last_active=a},show:function(a,b){if(this.drops.length){var c=[];this.last_active&&this.deactivate(this.last_active);this.drops.each(function(d){Droppables.isAffected(a,b,d)&&c.push(d)});if(c.length>0){drop=Droppables.findDeepestChild(c);Position.within(drop.element,a[0],a[1]);drop.onHover&&drop.onHover(b,drop.element,Position.overlap(drop.overlap,drop.element));Droppables.activate(drop)}}}, fire:function(a,b){if(this.last_active){Position.prepare();this.isAffected([Event.pointerX(a),Event.pointerY(a)],b,this.last_active)&&this.last_active.onDrop&&this.last_active.onDrop(b,this.last_active.element,a)}},reset:function(){this.last_active&&this.deactivate(this.last_active)}},Draggables={drags:[],observers:[],register:function(a){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress= this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress)}this.drags.push(a)},unregister:function(a){this.drags=this.drags.reject(function(b){return b==a});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress)}}, activate:function(a){if(a.options.delay)this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=a}.bind(this),a.options.delay);else{window.focus();this.activeDraggable=a}},deactivate:function(){this.activeDraggable=null},updateDrag:function(a){if(this.activeDraggable){var b=[Event.pointerX(a),Event.pointerY(a)];if(!(this._lastPointer&&this._lastPointer.inspect()==b.inspect())){this._lastPointer=b;this.activeDraggable.updateDrag(a,b)}}},endDrag:function(a){if(this._timeout){clearTimeout(this._timeout); this._timeout=null}if(this.activeDraggable){this._lastPointer=null;this.activeDraggable.endDrag(a);this.activeDraggable=null}},keyPress:function(a){this.activeDraggable&&this.activeDraggable.keyPress(a)},addObserver:function(a){this.observers.push(a);this._cacheObserverCallbacks()},removeObserver:function(a){this.observers=this.observers.reject(function(b){return b.element==a});this._cacheObserverCallbacks()},notify:function(a,b,c){this[a+"Count"]>0&&this.observers.each(function(d){d[a]&&d[a](a,b, c)});b.options[a]&&b.options[a](b,c)},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(a){Draggables[a+"Count"]=Draggables.observers.select(function(b){return b[a]}).length})}},Draggable=Class.create();Draggable._dragging={}; Draggable.prototype={initialize:function(a,b){var c={handle:false,reverteffect:function(d,e,f){var g=Math.sqrt(Math.abs(e^2)+Math.abs(f^2))*0.02;new Effect.Move(d,{x:-f,y:-e,duration:g,queue:{scope:"_draggable",position:"end"}})},endeffect:function(d){var e=typeof d._opacity=="number"?d._opacity:1;new Effect.Opacity(d,{duration:0.2,from:0.7,to:e,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[d]=false}})},zindex:1E3,revert:false,scroll:false,scrollSensitivity:20, scrollSpeed:15,snap:false,delay:0};b&&typeof b.endeffect=="undefined"&&Object.extend(c,{starteffect:function(d){d._opacity=Element.getOpacity(d);Draggable._dragging[d]=true;new Effect.Opacity(d,{duration:0.2,from:d._opacity,to:0.7})}});b=Object.extend(c,b||{});this.element=$(a);if(b.handle&&typeof b.handle=="string"){a=Element.childrenWithClassName(this.element,b.handle,true);if(a.length>0)this.handle=a[0]}if(!this.handle)this.handle=$(b.handle);if(!this.handle)this.handle=this.element;if(b.scroll&& !b.scroll.scrollTo&&!b.scroll.outerHTML){b.scroll=$(b.scroll);this._isScrollChild=Element.childOf(this.element,b.scroll)}Element.makePositioned(this.element);this.delta=this.currentDelta();this.options=b;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this)},currentDelta:function(){return[parseInt(Element.getStyle(this.element, "left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")]},initDrag:function(a){if(!(typeof Draggable._dragging[this.element]!="undefined"&&Draggable._dragging[this.element]))if(Event.isLeftClick(a)){var b=Event.element(a);if(!(b.tagName&&(b.tagName=="INPUT"||b.tagName=="SELECT"||b.tagName=="OPTION"||b.tagName=="BUTTON"||b.tagName=="TEXTAREA"))){var c=[Event.pointerX(a),Event.pointerY(a)],d=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(e){return c[e]-d[e]});Draggables.activate(this); Event.stop(a)}}},startDrag:function(a){this.dragging=true;if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0);this.element.style.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);Position.absolutize(this.element);this.element.parentNode.insertBefore(this._clone,this.element)}if(this.options.scroll)if(this.options.scroll==window){var b=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=b.left;this.originalScrollTop= b.top}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop}Draggables.notify("onStart",this,a);this.options.starteffect&&this.options.starteffect(this.element)},updateDrag:function(a,b){this.dragging||this.startDrag(a);Position.prepare();Droppables.show(b,this.element);Draggables.notify("onDrag",this,a);this.draw(b);this.options.change&&this.options.change(this);if(this.options.scroll){this.stopScrolling();var c;if(this.options.scroll==window)with(this._getWindowScroll(this.options.scroll))c= [left,top,left+width,top+height];else{c=Position.page(this.options.scroll);c[0]+=this.options.scroll.scrollLeft;c[1]+=this.options.scroll.scrollTop;c[0]+=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0;c[1]+=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;c.push(c[0]+this.options.scroll.offsetWidth);c.push(c[1]+this.options.scroll.offsetHeight)}var d=[0,0];if(b[0]<c[0]+this.options.scrollSensitivity)d[0]=b[0]-(c[0]+this.options.scrollSensitivity); if(b[1]<c[1]+this.options.scrollSensitivity)d[1]=b[1]-(c[1]+this.options.scrollSensitivity);if(b[0]>c[2]-this.options.scrollSensitivity)d[0]=b[0]-(c[2]-this.options.scrollSensitivity);if(b[1]>c[3]-this.options.scrollSensitivity)d[1]=b[1]-(c[3]-this.options.scrollSensitivity);this.startScrolling(d)}navigator.appVersion.indexOf("AppleWebKit")>0&&window.scrollBy(0,0);Event.stop(a)},finishDrag:function(a,b){this.dragging=false;if(this.options.ghosting){Position.relativize(this.element);Element.remove(this._clone); this._clone=null}b&&Droppables.fire(a,this.element);Draggables.notify("onEnd",this,a);if((a=this.options.revert)&&typeof a=="function")a=a(this.element);b=this.currentDelta();if(a&&this.options.reverteffect)this.options.reverteffect(this.element,b[1]-this.delta[1],b[0]-this.delta[0]);else this.delta=b;if(this.options.zindex)this.element.style.zIndex=this.originalZ;this.options.endeffect&&this.options.endeffect(this.element);Draggables.deactivate(this);Droppables.reset()},keyPress:function(a){if(a.keyCode== Event.KEY_ESC){this.finishDrag(a,false);Event.stop(a)}},endDrag:function(a){if(this.dragging){this.stopScrolling();this.finishDrag(a,true);Event.stop(a)}},draw:function(a){var b=Position.cumulativeOffset(this.element);if(this.options.ghosting){var c=Position.realOffset(this.element);window.status=c.inspect();b[0]+=c[0]-Position.deltaX;b[1]+=c[1]-Position.deltaY}c=this.currentDelta();b[0]-=c[0];b[1]-=c[1];if(this.options.scroll&&this.options.scroll!=window&&this._isScrollChild){b[0]-=this.options.scroll.scrollLeft- this.originalScrollLeft;b[1]-=this.options.scroll.scrollTop-this.originalScrollTop}c=[0,1].map(function(e){return a[e]-b[e]-this.offset[e]}.bind(this));if(this.options.snap)c=typeof this.options.snap=="function"?this.options.snap(c[0],c[1],this):this.options.snap instanceof Array?c.map(function(e,f){return Math.round(e/this.options.snap[f])*this.options.snap[f]}.bind(this)):c.map(function(e){return Math.round(e/this.options.snap)*this.options.snap}.bind(this));var d=this.element.style;if(!this.options.constraint|| this.options.constraint=="horizontal")d.left=c[0]+"px";if(!this.options.constraint||this.options.constraint=="vertical")d.top=c[1]+"px";if(d.visibility=="hidden")d.visibility=""},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null}},startScrolling:function(a){if(a[0]||a[1]){this.scrollSpeed=[a[0]*this.options.scrollSpeed,a[1]*this.options.scrollSpeed];this.lastScrolled=new Date;this.scrollInterval=setInterval(this.scroll.bind(this), 10)}},scroll:function(){var a=new Date,b=a-this.lastScrolled;this.lastScrolled=a;if(this.options.scroll==window)with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){a=b/1E3;this.options.scroll.scrollTo(left+a*this.scrollSpeed[0],top+a*this.scrollSpeed[1])}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*b/1E3;this.options.scroll.scrollTop+=this.scrollSpeed[1]*b/1E3}Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify("onDrag", this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*b/1E3;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*b/1E3;if(Draggables._lastScrollPointer[0]<0)Draggables._lastScrollPointer[0]=0;if(Draggables._lastScrollPointer[1]<0)Draggables._lastScrollPointer[1]=0;this.draw(Draggables._lastScrollPointer)}this.options.change&&this.options.change(this)},_getWindowScroll:function(a){var b, c,d;with(a.document){if(a.document.documentElement&&documentElement.scrollTop){b=documentElement.scrollTop;c=documentElement.scrollLeft}else if(a.document.body){b=body.scrollTop;c=body.scrollLeft}if(a.innerWidth){d=a.innerWidth;a=a.innerHeight}else if(a.document.documentElement&&documentElement.clientWidth){d=documentElement.clientWidth;a=documentElement.clientHeight}else{d=body.offsetWidth;a=body.offsetHeight}}return{top:b,left:c,width:d,height:a}}};var SortableObserver=Class.create(); SortableObserver.prototype={initialize:function(a,b){this.element=$(a);this.observer=b;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();this.lastValue!=Sortable.serialize(this.element)&&this.observer(this.element)}}; var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(a){for(;a.tagName!="BODY";){if(a.id&&Sortable.sortables[a.id])return a;a=a.parentNode}},options:function(a){if(a=Sortable._findRootElement($(a)))return Sortable.sortables[a.id]},destroy:function(a){if(a=Sortable.options(a)){Draggables.removeObserver(a.element);a.droppables.each(function(b){Droppables.remove(b)});a.draggables.invoke("destroy");delete Sortable.sortables[a.element.id]}},create:function(a, b){a=$(a);var c=Object.extend({element:a,tag:"li",dropOnEmpty:false,tree:false,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:a,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},b||{});this.destroy(a);var d={revert:true,scroll:c.scroll,scrollSpeed:c.scrollSpeed,scrollSensitivity:c.scrollSensitivity,delay:c.delay,ghosting:c.ghosting, constraint:c.constraint,handle:c.handle};if(c.starteffect)d.starteffect=c.starteffect;if(c.reverteffect)d.reverteffect=c.reverteffect;else if(c.ghosting)d.reverteffect=function(g){g.style.top=0;g.style.left=0};if(c.endeffect)d.endeffect=c.endeffect;if(c.zindex)d.zindex=c.zindex;var e={overlap:c.overlap,containment:c.containment,tree:c.tree,hoverclass:c.hoverclass,onHover:Sortable.onHover},f={onHover:Sortable.onEmptyHover,overlap:c.overlap,containment:c.containment,hoverclass:c.hoverclass};Element.cleanWhitespace(a); c.draggables=[];c.droppables=[];if(c.dropOnEmpty||c.tree){Droppables.add(a,f);c.droppables.push(a)}(this.findElements(a,c)||[]).each(function(g){var h=c.handle?Element.childrenWithClassName(g,c.handle)[0]:g;c.draggables.push(new Draggable(g,Object.extend(d,{handle:h})));Droppables.add(g,e);if(c.tree)g.treeNode=a;c.droppables.push(g)});if(c.tree)(Sortable.findTreeElements(a,c)||[]).each(function(g){Droppables.add(g,f);g.treeNode=a;c.droppables.push(g)});this.sortables[a.id]=c;Draggables.addObserver(new SortableObserver(a, c.onUpdate))},findElements:function(a,b){return Element.findChildren(a,b.only,b.tree?true:false,b.tag)},findTreeElements:function(a,b){return Element.findChildren(a,b.only,b.tree?true:false,b.treeTag)},onHover:function(a,b,c){if(!Element.isParent(b,a))if(!(c>0.33&&c<0.66&&Sortable.options(b).tree))if(c>0.5){Sortable.mark(b,"before");if(b.previousSibling!=a){c=a.parentNode;a.style.visibility="hidden";b.parentNode.insertBefore(a,b);b.parentNode!=c&&Sortable.options(c).onChange(a);Sortable.options(b.parentNode).onChange(a)}}else{Sortable.mark(b, "after");var d=b.nextSibling||null;if(d!=a){c=a.parentNode;a.style.visibility="hidden";b.parentNode.insertBefore(a,d);b.parentNode!=c&&Sortable.options(c).onChange(a);Sortable.options(b.parentNode).onChange(a)}}},onEmptyHover:function(a,b,c){var d=a.parentNode,e=Sortable.options(b);if(!Element.isParent(b,a)){var f=Sortable.findElements(b,{tag:e.tag,only:e.only}),g=null;if(f){var h=Element.offsetSize(b,e.overlap)*(1-c);for(c=0;c<f.length;c+=1)if(h-Element.offsetSize(f[c],e.overlap)>=0)h-=Element.offsetSize(f[c], e.overlap);else{g=h-Element.offsetSize(f[c],e.overlap)/2>=0?c+1<f.length?f[c+1]:null:f[c];break}}b.insertBefore(a,g);Sortable.options(d).onChange(a);e.onChange(a)}},unmark:function(){Sortable._marker&&Element.hide(Sortable._marker)},mark:function(a,b){var c=Sortable.options(a.parentNode);if(!(c&&!c.ghosting)){if(!Sortable._marker){Sortable._marker=$("dropmarker")||document.createElement("DIV");Element.hide(Sortable._marker);Element.addClassName(Sortable._marker,"dropmarker");Sortable._marker.style.position= "absolute";document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var d=Position.cumulativeOffset(a);Sortable._marker.style.left=d[0]+"px";Sortable._marker.style.top=d[1]+"px";if(b=="after")if(c.overlap=="horizontal")Sortable._marker.style.left=d[0]+a.clientWidth+"px";else Sortable._marker.style.top=d[1]+a.clientHeight+"px";Element.show(Sortable._marker)}},_tree:function(a,b,c){for(var d=Sortable.findElements(a,b)||[],e=0;e<d.length;++e){var f=d[e].id.match(b.format);if(f){f= {id:encodeURIComponent(f?f[1]:null),element:a,parent:c,children:[],position:c.children.length,container:Sortable._findChildrenElement(d[e],b.treeTag.toUpperCase())};f.container&&this._tree(f.container,b,f);c.children.push(f)}}return c},_findChildrenElement:function(a,b){if(a&&a.hasChildNodes)for(var c=0;c<a.childNodes.length;++c)if(a.childNodes[c].tagName==b)return a.childNodes[c];return null},tree:function(a,b){a=$(a);var c=this.options(a);b=Object.extend({tag:c.tag,treeTag:c.treeTag,only:c.only, name:a.id,format:c.format},b||{});c={id:null,parent:null,children:[],container:a,position:0};return Sortable._tree(a,b,c)},_constructIndex:function(a){var b="";do if(a.id)b="["+a.position+"]"+b;while((a=a.parent)!=null);return b},sequence:function(a,b){a=$(a);var c=Object.extend(this.options(a),b||{});return $(this.findElements(a,c)||[]).map(function(d){return d.id.match(c.format)?d.id.match(c.format)[1]:""})},setSequence:function(a,b,c){a=$(a);var d=Object.extend(this.options(a),c||{}),e={};this.findElements(a, d).each(function(f){if(f.id.match(d.format))e[f.id.match(d.format)[1]]=[f,f.parentNode];f.parentNode.removeChild(f)});b.each(function(f){var g=e[f];if(g){g[1].appendChild(g[0]);delete e[f]}})},serialize:function(a,b){a=$(a);var c=Object.extend(Sortable.options(a),b||{}),d=encodeURIComponent(b&&b.name?b.name:a.id);return c.tree?Sortable.tree(a,b).children.map(function(e){return[d+Sortable._constructIndex(e)+"[id]="+encodeURIComponent(e.id)].concat(e.children.map(arguments.callee))}).flatten().join("&"): Sortable.sequence(a,b).map(function(e){return d+"[]="+encodeURIComponent(e)}).join("&")}};Element.isParent=function(a,b){if(!a.parentNode||a==b)return false;if(a.parentNode==b)return true;return Element.isParent(a.parentNode,b)}; Element.findChildren=function(a,b,c,d){if(!a.hasChildNodes())return null;d=d.toUpperCase();if(b)b=[b].flatten();var e=[];$A(a.childNodes).each(function(f){if(f.tagName&&f.tagName.toUpperCase()==d&&(!b||Element.classNames(f).detect(function(g){return b.include(g)})))e.push(f);if(c)(f=Element.findChildren(f,b,c,d))&&e.push(f)});return e.length>0?e.flatten():[]};Element.offsetSize=function(a,b){return b=="vertical"||b=="height"?a.offsetHeight:a.offsetWidth};